<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hanza Bot - Blog Writing Assistant</title>
  <style>
    :root{
      --brand1:#95c59c; --brand2:#000501; --user1:#84a585; --user2:#467c4b;
      --bg:#faf6f4; --white:#fff; --border:#e2e8f0; --ink:#222;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:var(--ink);
      background: linear-gradient(135deg, #f3f3ee 0%, #faf6f4 100%);
      display:flex; justify-content:center; align-items:center; height:100vh;
    }
    .chat-container{
      width:90%; max-width:900px; height:90%;
      background:var(--white); border-radius:24px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.15);
      display:flex; flex-direction:column; overflow:hidden;
    }
    .chat-header{
      background: linear-gradient(135deg, var(--brand1) 0%, var(--brand2) 100%);
      color:white; padding:24px; font-size:20px; font-weight:700;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .actions{display:flex; gap:8px; align-items:center}
    .btn{
      border:1.5px solid rgba(255,255,255,.6); color:white; background:transparent;
      padding:8px 12px; border-radius:12px; cursor:pointer; font-weight:600; font-size:13px;
    }
    .btn:hover{background:rgba(255,255,255,.12)}
    .chat-messages{
      flex:1; padding:24px; overflow-y:auto; background:var(--bg);
    }
    .message{margin-bottom:20px; display:flex;}
    .message.user{justify-content:flex-end;}
    .message-content{
      max-width:75%; padding:12px 16px; border-radius:18px; font-size:15px; line-height:1.55;
      border:1px solid transparent; white-space:normal; word-wrap:break-word;
    }
    .message.user .message-content{
      background: linear-gradient(135deg, var(--user1) 0%, var(--user2) 100%); color:white;
    }
    .message.bot .message-content{
      background:var(--white); border-color:var(--border);
    }
    .chat-input-container{
      padding:16px 24px; background:var(--white); border-top:1px solid var(--border);
      display:flex; gap:12px; align-items:flex-end;
      position:relative;
    }
    .chat-input{
      flex:1; padding:14px 20px; border:2px solid var(--border); border-radius:24px;
      font-size:15px; resize:none; outline:none; max-height:160px; min-height:44px; line-height:1.4;
    }
    .send-button{
      background:#f3f3ee; border:2px solid var(--border); border-radius:24px;
      padding:14px 20px; font-weight:700; cursor:pointer; min-width:110px;
    }
    .send-button[disabled]{opacity:.6; cursor:not-allowed}
    .note{margin-top:4px; font-size:12px; opacity:.7;}
    /* Markdown prettify inside bot messages */
    .message.bot .message-content h1,.message.bot .message-content h2,.message.bot .message-content h3{margin:6px 0 8px}
    .message.bot .message-content h1{font-size:20px}
    .message.bot .message-content h2{font-size:18px}
    .message.bot .message-content h3{font-size:16px}
    .message.bot .message-content ul{margin:6px 0 6px 20px}
    .message.bot .message-content ol{margin:6px 0 6px 20px}
    .message.bot .message-content p{margin:6px 0}
    .message.bot .message-content code{
      background:#f6f6f6; border:1px solid #eee; padding:0 4px; border-radius:4px;
      font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }
    /* Mobile */
    @media (max-width:600px){
      .chat-container{width:100%; height:100%; border-radius:0;}
      .chat-input-container{position:sticky; bottom:0;}
      .send-button{min-width:auto}
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      üìù Hanza Bot
      <div class="actions">
        <button class="btn" id="exportBtn" title="Export chat as .md">Export .md</button>
      </div>
    </div>

    <div class="chat-messages" id="chatMessages">
      <div class="message bot">
        <div class="message-content">
          üëã Hi Hanza! I'm your AI assistant for writing blog posts in your voice and style.
          Ask me to create full posts, brainstorm topics, or polish drafts.
          <div class="note">Tip: press Enter to send, Shift+Enter for a new line.</div>
        </div>
      </div>
    </div>

    <div class="chat-input-container">
      <textarea class="chat-input" id="messageInput" placeholder="Write a blog post about leadership..." rows="1"></textarea>
      <button class="send-button" id="sendButton">Send üì§</button>
    </div>
  </div>

  <script>
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const exportBtn = document.getElementById('exportBtn');

    // Restore saved chat on load
    const saved = localStorage.getItem('hanza_chat_v1');
    if (saved) chatMessages.innerHTML = saved;

    // Auto-resize textarea
    messageInput.addEventListener('input', () => {
      messageInput.style.height = 'auto';
      messageInput.style.height = Math.min(messageInput.scrollHeight, 160) + 'px';
    });

    function saveChat() {
      localStorage.setItem('hanza_chat_v1', chatMessages.innerHTML);
    }

    // Minimal Markdown renderer (safe-ish)
    function renderMarkdown(mdText = '') {
      // escape HTML
      const esc = s => s.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
      let s = esc(mdText);

      // headings
      s = s.replace(/^### (.*)$/gm, '<h3>$1</h3>');
      s = s.replace(/^## (.*)$/gm, '<h2>$1</h2>');
      s = s.replace(/^# (.*)$/gm, '<h1>$1</h1>');

      // bold/italic
      s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');

      // lists
      s = s.replace(/^\s*[-*]\s+(.*)$/gm, '<li>$1</li>');
      s = s.replace(/^\s*\d+\.\s+(.*)$/gm, '<li>$1</li>');
      s = s.replace(/(?:<li>.*<\/li>\n?)+/g, m => `<ul>${m}</ul>`);

      // paragraphs (don‚Äôt wrap block tags)
      s = s.replace(/(^|\n)([^\n<][^\n]*)/g, (m, a, b) => {
        if (/^\s*<(h\d|ul|li|\/ul)/.test(b)) return m;
        return `${a}<p>${b}</p>`;
      });

      return s;
    }

    function addMessage(content, isUser = false, isHtml = false) {
      const message = document.createElement('div');
      message.classList.add('message', isUser ? 'user' : 'bot');
      const contentDiv = document.createElement('div');
      contentDiv.classList.add('message-content');

      if (isHtml) contentDiv.innerHTML = content;
      else contentDiv.textContent = content;

      message.appendChild(contentDiv);
      chatMessages.appendChild(message);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      saveChat();
    }

    function showTypingIndicator() {
      const typing = document.createElement('div');
      typing.classList.add('message', 'bot', 'typing');
      typing.innerHTML = `<div class="message-content">Hanza is typing...</div>`;
      chatMessages.appendChild(typing);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return typing;
    }

    function removeTypingIndicator() {
      const typing = document.querySelector('.message.typing');
      if (typing) typing.remove();
      saveChat();
    }

    async function getBotResponse(userMessage) {
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: userMessage })
        });

        // In case server returns non-JSON (proxy/network issue)
        const data = await response.json().catch(() => ({}));

        if (data && typeof data.reply === 'string' && data.reply.trim()) {
          return data.reply;
        }

        if (!response.ok) {
          if (response.status === 429) {
            return "‚ö†Ô∏è Your AI quota is out. Add billing to your OpenAI project, or enable DEMO_MODE on the server.";
          }
          return "‚ö†Ô∏è The AI service returned an error. Please try again.";
        }

        return "‚ö†Ô∏è No reply from server.";
      } catch (error) {
        return "‚ö†Ô∏è Error reaching the AI. Please try again.";
      }
    }

    async function handleSend() {
      const userMessage = messageInput.value.trim();
      if (!userMessage) return;

      addMessage(userMessage, true);
      messageInput.value = '';
      messageInput.style.height = 'auto';

      // prevent double send while waiting
      sendButton.disabled = true;

      const typingNode = showTypingIndicator();
      const reply = await getBotResponse(userMessage);
      removeTypingIndicator(typingNode);

      // Render bot reply as Markdown -> HTML
      const html = renderMarkdown(reply);
      addMessage(html, false, true);

      sendButton.disabled = false;
    }

    sendButton.addEventListener('click', handleSend);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    // Export chat as Markdown
    exportBtn.addEventListener('click', () => {
      const parts = Array.from(document.querySelectorAll('.message')).map(m => {
        const isUser = m.classList.contains('user');
        // remove note text in the very first bubble if present
        const raw = m.querySelector('.message-content').innerText.replace(/\s*Tip:.*$/,'').trim();
        return `${isUser ? 'You' : 'Hanza'}:\n${raw}\n`;
      }).join('\n---\n\n');
      const blob = new Blob([parts], {type:'text/markdown;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'hanza_session.md'; a.click();
      URL.revokeObjectURL(url);
    });

    // Focus input on load
    messageInput.focus();
  </script>
</body>
</html>
